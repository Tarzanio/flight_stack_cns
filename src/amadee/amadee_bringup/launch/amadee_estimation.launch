<?xml version="1.0" encoding="UTF-8"?>
<launch>
  <arg name="pi"                        default="1" />
  <arg name="use_openvins"              default="True" /> <!-- if False it will use mocap -->
  <arg name="use_px4_bridge"            default="False" /> <!-- if False it will setup mars to input into PX4 EKF2 -->
  <arg name="type"                      default="vio" />

  <!-- OV arguments -->
  <arg name="ov_imu_in"           default="/mavros/imu/data_raw" />
  <arg name="ov_cam_in1"          default="/camera_downsample/image_downsample" /> <!-- to be checked -->
  <arg name="ov_cam_in2"          default="/camera_downsample/image_downsample" />
  <arg name="ov_use_stereo"       default="False" />

  <!-- MaRS arguments -->
  <arg name="mars_imu_in"               default="/mavros/imu/data_raw" />
  <arg name="mars_transform_in"         default="/twins_amadee/vrpn_client/raw_transform" />
  <arg name="mars_pose_in"              default="/ov_msckf/poseimu" />
  <arg name="mars_pose_out"             default="/mavros/vision_pose/pose" />

  <arg name="mars_gps1_coord_in"        default="/rtk_gps_1/fix" />
  <arg name="mars_gps1_vel_in"          default="/rtk_gps_1/fix_velocity" />
  <arg name="mars_gps2_coord_in"        default="/rtk_gps_2/fix" />
  <arg name="mars_gps2_vel_in"          default="/rtk_gps_2/fix_velocity" />

  <arg name="mars_lite_ext_state_out"   default="/mavros/external_state_lite/external_state_estimate_lite" />

  <!-- Camera downsample arguments -->
  <arg name="downsample_factor"               default="16" />
  <arg name="image_raw_topic"                 default="/camera/image_raw" />
 
  <group if="$(eval arg('pi') == 1)">

    <!-- Multi GPS with Velocity -->
    <group if="$(eval arg('type') == 'gps')">
      <!-- MaRS Estimator -->
      
      <include file="$(find mars_ros)/launch/mars_multi_gps_vel.launch">
        <!-- Input -->
        <arg name="imu_in_topic" value="$(arg mars_imu_in)" />
        
        <arg name="gps1_coord_in" value="$(arg mars_gps1_coord_in)" />
        <arg name="gps1_vel_in"   value="$(arg mars_gps1_vel_in)" />

        <arg name="gps2_coord_in" value="$(arg mars_gps2_coord_in)" />
        <arg name="gps2_vel_in"   value="$(arg mars_gps2_vel_in)" />

        <!-- Output Core State -->
        <arg name="full_state_out_topic"      default="~full_state_out" />
        <arg name="full_state_lite_out_topic" value="$(arg mars_lite_ext_state_out)" />
        <arg name="pose_state_out_topic"      value="$(arg mars_pose_out)" />
        <arg name="odom_state_out_topic"      default="~odom_state_out" />
    
        <!-- Output Calibration State -->
        <arg name="gps1_cal_state_out_topic" default="~gps1_cal_state_out" />
        <arg name="gps2_cal_state_out_topic" default="~gps2_cal_state_out" />

        <!-- Node Options -->
        <arg name="respawn" default="false" />
      </include>

    </group>

    <!-- VIO -->
    <group if="$(eval arg('type') == 'vio')">
      <!-- MaRS Estimator -->
      <include file="$(find mars_ros)/launch/mars_pose.launch" >
        <!-- Input -->
        <arg name="imu_in_topic"                  value="$(arg mars_imu_in)" />
        <arg name="transform_in_topic"            value="$(arg mars_transform_in)" unless="$(arg use_openvins)" />
        <arg name="pose_with_cov_in_topic"        value="$(arg mars_pose_in)" if="$(arg use_openvins)" />
        <!-- Output Core State -->        
        <arg name="full_state_lite_out_topic"     value="$(arg mars_lite_ext_state_out)" if="$(arg use_px4_bridge)" />
        <arg name="pose_state_out_topic"          value="$(arg mars_pose_out)" unless="$(arg use_px4_bridge)"  />
      </include>
      <!-- Camera downsample --> <!-- Remember to set extrinsic and intrinsic into node launch file -->
      <include file="$(find camera_downsample)/launch/camera_downsample.launch" >
        <arg name="downsample_factor"             value="$(arg downsample_factor)" />
        <arg name="image_raw_topic"               value="$(arg image_raw_topic)" />
      </include>
    </group>

  </group>

  <group if="$(eval arg('pi') == 2 and arg('type') == 'vio')">
    <!-- OpenVINS Estimator -->
    <include file="$(find amadee_bringup)/launch/openvins.launch" if="$(arg use_openvins)" >
      <arg name="topic_imu"     value="$(arg ov_imu_in)" />
      <arg name="topic_camera0" value="$(arg ov_cam_in1)" />
      <arg name="topic_camera1" value="$(arg ov_cam_in2)" />
      <arg name="use_stereo"    value="$(arg ov_use_stereo)" />
    </include>
  </group>

</launch>
